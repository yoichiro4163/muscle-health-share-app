<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°å…±æœ‰ã‚¢ãƒ—ãƒª</title>
    
    <script src="[https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js](https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js)"></script>
    <script src="[https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js](https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js)"></script>
    <script src="[https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js](https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js)"></script>

    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #f4f7f6;
            color: #333;
            margin: 0; padding: 20px;
            display: flex; flex-direction: column; align-items: center; min-height: 100vh;
        }
        .container {
            width: 100%; max-width: 400px; background: white; padding: 20px;
            border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        h1, h2, h3 { text-align: center; color: #2c3e50; margin-bottom: 15px; }
        h1 { font-size: 1.8em; }
        h2 { font-size: 1.2em; border-left: 5px solid #2ecc71; padding-left: 10px; margin-top: 30px;}
        hr { border: 0; border-top: 1px solid #eee; margin: 20px 0; }

        input { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 16px; }
        button { width: 100%; padding: 12px; margin: 5px 0; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; color: white; transition: opacity 0.2s; }
        button:active { opacity: 0.8; }

        #emailLoginButton { background-color: #3498db; }
        #emailRegisterButton { background-color: #95a5a6; }
        #logoutButton { background-color: #e74c3c; margin-top: 10px;}
        #updateProfileButton { background-color: #2c3e50; margin-top: 5px; font-size: 0.9em; padding: 8px;}
        
        #foodForm button { background-color: #f1c40f; color: #333; }
        #startButton { background-color: #2ecc71; }
        #stopButton { background-color: #e74c3c; }
        #authContainer { background-color: #eef2f3; padding: 20px; border-radius: 12px; margin-bottom: 20px; }
        #timer { font-size: 3.5em; font-family: 'Courier New', monospace; text-align: center; margin: 20px 0; color: #2c3e50; }
        
        #timelineList { list-style: none; padding: 0; }
        #timelineList li { background: #fff; border-bottom: 1px solid #eee; padding: 15px 10px; }
        .user-name { color: #3498db; font-weight: bold; font-size: 0.9em; }
        .memo-text { font-weight: bold; color: #333; margin: 5px 0; display: block; } /* ãƒ¡ãƒ¢ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        strong { color: #2ecc71; }
        small { color: #888; display: block; margin-top: 5px; font-size: 0.85em;}
    </style>
</head>
<body>

    <div class="container">
        <div id="authContainer">
            <div id="loginForm">
                <h3>ãƒ­ã‚°ã‚¤ãƒ³ / æ–°è¦ç™»éŒ²</h3>
                <input type="email" id="emailInput" placeholder="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹">
                <input type="password" id="passwordInput" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
                <button id="emailLoginButton">ãƒ­ã‚°ã‚¤ãƒ³</button>
                <button id="emailRegisterButton">æ–°è¦ç™»éŒ²</button>
            </div>

            <div id="userInfo" style="display: none;">
                <p>ã‚ˆã†ã“ãã€<span id="userName" style="font-weight:bold; font-size:1.2em;"></span> ã•ã‚“ï¼</p>
                <details style="margin-bottom: 10px; cursor: pointer;">
                    <summary style="font-size: 0.9em; color: #555;">ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã‚’å¤‰æ›´ã™ã‚‹</summary>
                    <input type="text" id="nicknameInput" placeholder="æ–°ã—ã„ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ">
                    <button id="updateProfileButton">å¤‰æ›´ã‚’ä¿å­˜</button>
                </details>
                <button id="logoutButton">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
            </div>
        </div>

        <hr>

        <h2>é£Ÿäº‹ã®è¨˜éŒ² ğŸ½ï¸</h2>
        <form id="foodForm">
            <p>é£Ÿäº‹ã®å†™çœŸã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</p>
            <input type="text" id="foodMemo" placeholder="ãƒ¡ãƒ¢ï¼ˆä¾‹: é¶ã‚€ã­è‚‰ã®ã‚µãƒ©ãƒ€ï¼‰">
            <input type="file" id="foodImage" accept="image/*">
            <button type="submit">é€ä¿¡</button>
        </form>
        <div id="foodResult" style="margin-top:10px;"></div>

        <hr>

        <h2>ã¿ã‚“ãªã®æ´»å‹•ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³</h2>
        <ul id="timelineList">
            <li>èª­ã¿è¾¼ã¿ä¸­...</li>
        </ul>

        <hr>

        <h1>ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°</h1>
        <div id="timer">00:00:00</div>
        <input type="text" id="trainingMemo" placeholder="å†…å®¹ï¼ˆä¾‹: ãƒ™ãƒ³ãƒãƒ—ãƒ¬ã‚¹ 50kg x 10ï¼‰">
        
        <div>
            <button id="startButton">é–‹å§‹</button>
            <button id="stopButton">çµ‚äº† & è¨˜éŒ²</button>
        </div>
        <div id="result" style="margin-top:10px;"></div>
    </div>

    <script>
        // å¤‰æ•°å®šç¾©
        const loginForm = document.getElementById('loginForm');
        const emailInput = document.getElementById('emailInput');
        const passwordInput = document.getElementById('passwordInput');
        const emailLoginButton = document.getElementById('emailLoginButton');
        const emailRegisterButton = document.getElementById('emailRegisterButton');
        const userInfo = document.getElementById('userInfo');
        const userName = document.getElementById('userName');
        const logoutButton = document.getElementById('logoutButton');
        const nicknameInput = document.getElementById('nicknameInput');
        const updateProfileButton = document.getElementById('updateProfileButton');

        const foodForm = document.getElementById('foodForm');
        const foodImageInput = document.getElementById('foodImage');
        const foodMemoInput = document.getElementById('foodMemo'); // â˜…è¿½åŠ 
        const foodResultElement = document.getElementById('foodResult');
        
        const timelineList = document.getElementById('timelineList');
        
        const timerElement = document.getElementById('timer');
        const trainingMemoInput = document.getElementById('trainingMemo'); // â˜…è¿½åŠ 
        const startButton = document.getElementById('startButton');
        const stopButton = document.getElementById('stopButton');
        const resultElement = document.getElementById('result');

        // â˜…â˜…â˜… ã“ã“ã«ã‚ãªãŸã®Firebaseè¨­å®šã‚’ä¸Šæ›¸ãã—ã¦ãã ã•ã„ï¼ â˜…â˜…â˜…
        const firebaseConfig = {
            apiKey: "AIzaSyBlSmhMCPEy9pQ5dcDQf7Nbfg-QLol0Y1s",
            authDomain: "muscle-health-share-app.firebaseapp.com",
            projectId: "muscle-health-share-app",
            storageBucket: "muscle-health-share-app.firebasestorage.app",
            messagingSenderId: "943104458821",
            appId: "1:943104458821:web:81200c236e0e33c394632c",
            measurementId: "G-WTF627DY4K"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db_js = firebase.firestore();

        // èªè¨¼é–¢é€£
        emailRegisterButton.addEventListener('click', () => {
            const email = emailInput.value; const password = passwordInput.value;
            if(!email || !password) return alert('å…¥åŠ›ã—ã¦ãã ã•ã„');
            auth.createUserWithEmailAndPassword(email, password).catch(e => alert(e.message));
        });
        emailLoginButton.addEventListener('click', () => {
            const email = emailInput.value; const password = passwordInput.value;
            if(!email || !password) return alert('å…¥åŠ›ã—ã¦ãã ã•ã„');
            auth.signInWithEmailAndPassword(email, password).catch(e => alert(e.message));
        });
        logoutButton.addEventListener('click', () => auth.signOut());
        updateProfileButton.addEventListener('click', () => {
            const newName = nicknameInput.value;
            if(auth.currentUser && newName) {
                auth.currentUser.updateProfile({ displayName: newName })
                    .then(() => { alert('æ›´æ–°ã—ã¾ã—ãŸ'); userName.textContent = newName; });
            }
        });
        auth.onAuthStateChanged((user) => {
            if (user) {
                loginForm.style.display = 'none'; userInfo.style.display = 'block';
                userName.textContent = user.displayName || user.email;
                loadActivities();
            } else {
                loginForm.style.display = 'block'; userInfo.style.display = 'none';
                timelineList.innerHTML = '<li>ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„</li>';
            }
        });

        // ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³èª­ã¿è¾¼ã¿
        async function loadActivities() {
            try {
                const response = await fetch('/get_activities');
                const activities = await response.json();
                timelineList.innerHTML = ''; 
                activities.forEach(activity => {
                    const name = activity.user_name || 'åç„¡ã—ã•ã‚“';
                    // â˜…è¿½åŠ : ãƒ¡ãƒ¢ãŒã‚ã‚Œã°è¡¨ç¤ºã™ã‚‹
                    const memo = activity.memo ? `<span class="memo-text">ã€Œ${activity.memo}ã€</span>` : '';
                    
                    const li = document.createElement('li');
                    let content = `<div class="user-name">${name}</div>`;
                    
                    if (activity.type === 'food') {
                        content += `<strong>ã€é£Ÿäº‹ã€‘</strong> ${memo} ${activity.calories} / ${activity.pfc}`;
                    } else if (activity.type === 'training') {
                        content += `<strong>ã€ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã€‘</strong> ${memo} ${activity.duration}`;
                    }
                    content += `<small>${activity.timestamp_str}</small>`;
                    li.innerHTML = content;
                    timelineList.appendChild(li);
                });
            } catch (error) { console.error(error); }
        }

        // é£Ÿäº‹è¨˜éŒ²
        foodForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const file = foodImageInput.files[0];
            if (!file) return;
            const user = auth.currentUser;
            if (!user) return alert('ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„');

            foodResultElement.textContent = 'AIåˆ†æä¸­...';
            const formData = new FormData();
            formData.append('image', file);
            formData.append('user_name', user.displayName || user.email);
            // â˜…è¿½åŠ : ãƒ¡ãƒ¢ã‚’é€ã‚‹
            formData.append('memo', foodMemoInput.value);

            try {
                const res = await fetch('/analyze', { method: 'POST', body: formData });
                const data = await res.json();
                if (res.ok) {
                    foodResultElement.innerHTML = `è¨˜éŒ²å®Œäº†: ${data.calories}`;
                    foodMemoInput.value = ''; // å…¥åŠ›æ¬„ã‚’ç©ºã«ã™ã‚‹
                    foodImageInput.value = '';
                    loadActivities();
                } else { foodResultElement.textContent = 'ã‚¨ãƒ©ãƒ¼: ' + data.error; }
            } catch (err) { console.error(err); }
        });

        // ã‚¿ã‚¤ãƒãƒ¼
        let startTime, timerInterval = null;
        startButton.addEventListener('click', () => {
            if (timerInterval) return;
            startTime = Date.now();
            timerInterval = setInterval(() => {
                timerElement.textContent = formatTime(Date.now() - startTime);
            }, 1000);
            resultElement.textContent = '';
        });

        stopButton.addEventListener('click', async () => {
            if (!timerInterval) return;
            clearInterval(timerInterval);
            timerInterval = null;
            const formattedTime = formatTime(Date.now() - startTime);
            
            const user = auth.currentUser;
            if (!user) return alert('ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„');

            try {
                await fetch('/log_training', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        'duration': formattedTime,
                        'user_name': user.displayName || user.email,
                        // â˜…è¿½åŠ : ãƒ¡ãƒ¢ã‚’é€ã‚‹
                        'memo': trainingMemoInput.value
                    })
                });
                loadActivities();
                trainingMemoInput.value = ''; // å…¥åŠ›æ¬„ã‚’ç©ºã«ã™ã‚‹
            } catch (err) { console.error(err); }
            resultElement.textContent = `ãŠç–²ã‚Œæ§˜ï¼ æ™‚é–“: ${formattedTime}`;
        });

        function formatTime(ms) {
            const s = Math.floor(ms / 1000) % 60;
            const m = Math.floor(ms / 1000 / 60) % 60;
            const h = Math.floor(ms / 1000 / 3600);
            return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
        }
    </script>
</body>
</html>