 <!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>„Éà„É¨„Éº„Éã„É≥„Ç∞ÂÖ±Êúâ„Ç¢„Éó„É™</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #f4f7f6;
            color: #333;
            margin: 0; padding: 20px;
            display: flex; flex-direction: column; align-items: center; min-height: 100vh;
        }
        .container {
            width: 100%; max-width: 400px; background: white; padding: 20px;
            border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        h1, h2, h3 { text-align: center; color: #2c3e50; margin-bottom: 15px; }
        h1 { font-size: 1.8em; }
        h2 { font-size: 1.2em; border-left: 5px solid #2ecc71; padding-left: 10px; margin-top: 30px;}
        hr { border: 0; border-top: 1px solid #eee; margin: 20px 0; }

        input { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 16px; }
        button { width: 100%; padding: 12px; margin: 5px 0; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; color: white; transition: opacity 0.2s; }
        button:active { opacity: 0.8; }

        #emailLoginButton { background-color: #3498db; }
        #emailRegisterButton { background-color: #95a5a6; }
        #logoutButton { background-color: #e74c3c; margin-top: 10px;}
        #updateProfileButton { background-color: #2c3e50; margin-top: 5px; font-size: 0.9em; padding: 8px;}
        
        #foodForm button { background-color: #f1c40f; color: #333; }
        #startButton { background-color: #2ecc71; }
        #stopButton { background-color: #e74c3c; }
        #authContainer { background-color: #eef2f3; padding: 20px; border-radius: 12px; margin-bottom: 20px; }
        #timer { font-size: 3.5em; font-family: 'Courier New', monospace; text-align: center; margin: 20px 0; color: #2c3e50; }
        
        #timelineList { list-style: none; padding: 0; }
        #timelineList li { background: #fff; border-bottom: 1px solid #eee; padding: 15px 10px; }
        .user-name { color: #3498db; font-weight: bold; font-size: 0.9em; }
        .memo-text { font-weight: bold; color: #333; margin: 5px 0; display: block; }
        strong { color: #2ecc71; }
        small { color: #888; display: block; margin-top: 5px; font-size: 0.85em;}
        
        /* „Ç∞„É´„Éº„Éó„Éë„Çπ„ÉØ„Éº„ÉâÁî®„ÅÆ„Çπ„Çø„Ç§„É´ */
        #groupPassInput { border: 2px solid #f1c40f; background-color: #fffcf0; }
    </style>
</head>
<body>

    <div class="container">
        <div id="authContainer">
            <div id="loginForm">
                <h3>„É≠„Ç∞„Ç§„É≥ / Êñ∞Ë¶èÁôªÈå≤</h3>
                <input type="email" id="emailInput" placeholder="„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ">
                <input type="password" id="passwordInput" placeholder="„Éë„Çπ„ÉØ„Éº„Éâ">
                
                <input type="password" id="groupPassInput" placeholder="„Ç∞„É´„Éº„Éó„Éë„Çπ„ÉØ„Éº„ÉâÔºàÊñ∞Ë¶èÁôªÈå≤ÊôÇ„ÅÆ„ÅøÔºâ">
                
                <button id="emailLoginButton">„É≠„Ç∞„Ç§„É≥</button>
                <button id="emailRegisterButton">Êñ∞Ë¶èÁôªÈå≤</button>
            </div>

            <div id="userInfo" style="display: none;">
                <p>„Çà„ÅÜ„Åì„Åù„ÄÅ<span id="userName" style="font-weight:bold; font-size:1.2em;"></span> „Åï„ÇìÔºÅ</p>
                <details style="margin-bottom: 10px; cursor: pointer;">
                    <summary style="font-size: 0.9em; color: #555;">„Éã„ÉÉ„ÇØ„Éç„Éº„É†„ÇíÂ§âÊõ¥„Åô„Çã</summary>
                    <input type="text" id="nicknameInput" placeholder="Êñ∞„Åó„ÅÑ„Éã„ÉÉ„ÇØ„Éç„Éº„É†">
                    <button id="updateProfileButton">Â§âÊõ¥„Çí‰øùÂ≠ò</button>
                </details>
                <button id="logoutButton">„É≠„Ç∞„Ç¢„Ç¶„Éà</button>
            </div>
        </div>

        <hr>

        <h2>È£ü‰∫ã„ÅÆË®òÈå≤ üçΩÔ∏è</h2>
        <form id="foodForm">
            <p>È£ü‰∫ã„ÅÆÂÜôÁúü„Çí„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ</p>
            <input type="text" id="foodMemo" placeholder="„É°„É¢Ôºà‰æã: „Éó„É≠„ÉÜ„Ç§„É≥„ÅÆ„ÅøÔºâ">
            <input type="file" id="foodImage" accept="image/*">
            <button type="submit">ÈÄÅ‰ø°</button>
        </form>
        <div id="foodResult" style="margin-top:10px;"></div>

        <hr>

        <h2>„Åø„Çì„Å™„ÅÆÊ¥ªÂãï„Çø„Ç§„É†„É©„Ç§„É≥</h2>
        <ul id="timelineList">
            <li>Ë™≠„ÅøËæº„Åø‰∏≠...</li>
        </ul>

        <hr>

        <h1>„Éà„É¨„Éº„Éã„É≥„Ç∞</h1>
        <div id="timer">00:00:00</div>
        <input type="text" id="trainingMemo" placeholder="ÂÜÖÂÆπÔºà‰æã: „Éô„É≥„ÉÅ„Éó„É¨„Çπ 50kg x 10Ôºâ">
        
        <div>
            <button id="startButton">ÈñãÂßã</button>
            <button id="stopButton">ÁµÇ‰∫Ü & Ë®òÈå≤</button>
        </div>
        <div id="result" style="margin-top:10px;"></div>
    </div>

    <script>
        // Â§âÊï∞ÂÆöÁæ©
        const loginForm = document.getElementById('loginForm');
        const emailInput = document.getElementById('emailInput');
        const passwordInput = document.getElementById('passwordInput');
        const emailLoginButton = document.getElementById('emailLoginButton');
        const emailRegisterButton = document.getElementById('emailRegisterButton');
        const groupPassInput = document.getElementById('groupPassInput'); // ‚òÖËøΩÂä†

        const userInfo = document.getElementById('userInfo');
        const userName = document.getElementById('userName');
        const logoutButton = document.getElementById('logoutButton');
        const nicknameInput = document.getElementById('nicknameInput');
        const updateProfileButton = document.getElementById('updateProfileButton');

        const foodForm = document.getElementById('foodForm');
        const foodImageInput = document.getElementById('foodImage');
        const foodMemoInput = document.getElementById('foodMemo');
        const foodResultElement = document.getElementById('foodResult');
        
        const timelineList = document.getElementById('timelineList');
        const timerElement = document.getElementById('timer');
        const trainingMemoInput = document.getElementById('trainingMemo');
        const startButton = document.getElementById('startButton');
        const stopButton = document.getElementById('stopButton');
        const resultElement = document.getElementById('result');

        // ‚òÖ‚òÖ‚òÖ „Åì„Åì„Å´„ÅÇ„Å™„Åü„ÅÆFirebaseË®≠ÂÆö„Çí‰∏äÊõ∏„Åç„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºÅ ‚òÖ‚òÖ‚òÖ
        const firebaseConfig = {
            apiKey: "AIzaSyBlSmhMCPEy9pQ5dcDQf7Nbfg-QLol0Y1s",
            authDomain: "muscle-health-share-app.firebaseapp.com",
            projectId: "muscle-health-share-app",
            storageBucket: "muscle-health-share-app.firebasestorage.app",
            messagingSenderId: "943104458821",
            appId: "1:943104458821:web:81200c236e0e33c394632c",
            measurementId: "G-WTF627DY4K"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db_js = firebase.firestore();

        // ‚òÖ‰øÆÊ≠£: Êñ∞Ë¶èÁôªÈå≤„Éú„Çø„É≥„ÅÆÂá¶ÁêÜ
        emailRegisterButton.addEventListener('click', () => {
            const email = emailInput.value; 
            const password = passwordInput.value;
            const groupPass = groupPassInput.value; // ÂÖ•Âäõ„Åï„Çå„Åü„Ç∞„É´„Éº„Éó„Éë„Çπ„ÉØ„Éº„Éâ

            if(!email || !password) return alert('„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„Å®„Éë„Çπ„ÉØ„Éº„Éâ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
            
            // ‚òÖ„Åì„Åì„Åß„Éë„Çπ„ÉØ„Éº„Éâ„ÉÅ„Çß„ÉÉ„ÇØÔºÅ
            if(groupPass !== '4163') {
                return alert('„Ç∞„É´„Éº„Éó„Éë„Çπ„ÉØ„Éº„Éâ„ÅåÈÅï„ÅÑ„Åæ„ÅôÔºÅ\n„Åì„ÅÆ„Ç¢„Éó„É™„ÅØ‰ª≤ÈñìÂ∞ÇÁî®„Åß„Åô„ÄÇ');
            }

            auth.createUserWithEmailAndPassword(email, password)
                .then((cred) => {
                    console.log('ÁôªÈå≤ÊàêÂäü');
                    alert('„Çà„ÅÜ„Åì„ÅùÔºÅÁôªÈå≤„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„ÅüÔºÅ');
                })
                .catch((e) => alert('ÁôªÈå≤Â§±Êïó: ' + e.message));
        });

        // „É≠„Ç∞„Ç§„É≥„Éú„Çø„É≥ („Åì„Å°„Çâ„ÅØ„Ç∞„É´„Éº„Éó„Éë„Çπ„ÉØ„Éº„Éâ‰∏çË¶Å)
        emailLoginButton.addEventListener('click', () => {
            const email = emailInput.value; 
            const password = passwordInput.value;
            if(!email || !password) return alert('ÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
            auth.signInWithEmailAndPassword(email, password)
                .then((cred) => console.log('„É≠„Ç∞„Ç§„É≥ÊàêÂäü'))
                .catch((e) => alert('„É≠„Ç∞„Ç§„É≥Â§±Êïó: ' + e.message));
        });

        logoutButton.addEventListener('click', () => auth.signOut());
        
        updateProfileButton.addEventListener('click', () => {
            const newName = nicknameInput.value;
            if(auth.currentUser && newName) {
                auth.currentUser.updateProfile({ displayName: newName })
                    .then(() => { alert('Êõ¥Êñ∞„Åó„Åæ„Åó„Åü'); userName.textContent = newName; });
            }
        });

        auth.onAuthStateChanged((user) => {
            if (user) {
                loginForm.style.display = 'none'; userInfo.style.display = 'block';
                userName.textContent = user.displayName || user.email;
                loadActivities();
            } else {
                loginForm.style.display = 'block'; userInfo.style.display = 'none';
                timelineList.innerHTML = '<li>„É≠„Ç∞„Ç§„É≥„Åó„Å¶„Åè„Å†„Åï„ÅÑ</li>';
            }
        });

        // „Çø„Ç§„É†„É©„Ç§„É≥Ë™≠„ÅøËæº„Åø
        async function loadActivities() {
            try {
                const response = await fetch('/get_activities');
                const activities = await response.json();
                timelineList.innerHTML = ''; 
                activities.forEach(activity => {
                    const name = activity.user_name || 'ÂêçÁÑ°„Åó„Åï„Çì';
                    const memo = activity.memo ? `<span class="memo-text">„Äå${activity.memo}„Äç</span>` : '';
                    
                    const li = document.createElement('li');
                    let content = `<div class="user-name">${name}</div>`;
                    
                    if (activity.type === 'food') {
                        if (activity.calories === '---') {
                            content += `<strong>„ÄêÈ£ü‰∫ã„É°„É¢„Äë</strong> ${memo}`;
                        } else {
                            content += `<strong>„ÄêÈ£ü‰∫ã„Äë</strong> ${memo} ${activity.calories} / ${activity.pfc}`;
                        }
                    } else if (activity.type === 'training') {
                        content += `<strong>„Äê„Éà„É¨„Éº„Éã„É≥„Ç∞„Äë</strong> ${memo} ${activity.duration}`;
                    }
                    content += `<small>${activity.timestamp_str}</small>`;
                    li.innerHTML = content;
                    timelineList.appendChild(li);
                });
            } catch (error) { console.error(error); }
        }

        // È£ü‰∫ãË®òÈå≤
        foodForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const file = foodImageInput.files[0];
            const memo = foodMemoInput.value;
            const user = auth.currentUser;
            if (!user) return alert('„É≠„Ç∞„Ç§„É≥„Åó„Å¶„Åè„Å†„Åï„ÅÑ');

            if (!file && !memo) return alert('ÂÜôÁúü„Åæ„Åü„ÅØ„É°„É¢„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');

            if (!file) {
                try {
                    await fetch('/log_food_text', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            'user_name': user.displayName || user.email,
                            'memo': memo 
                        })
                    });
                    foodMemoInput.value = '';
                    loadActivities();
                } catch (err) { console.error(err); }
                return;
            }

            foodResultElement.textContent = 'AIÂàÜÊûê‰∏≠...';
            const formData = new FormData();
            formData.append('image', file);
            formData.append('user_name', user.displayName || user.email);
            formData.append('memo', memo);

            try {
                const res = await fetch('/analyze', { method: 'POST', body: formData });
                const data = await res.json();
                if (res.ok) {
                    foodResultElement.innerHTML = `Ë®òÈå≤ÂÆå‰∫Ü: ${data.calories}`;
                    foodMemoInput.value = '';
                    foodImageInput.value = '';
                    loadActivities();
                } else { foodResultElement.textContent = '„Ç®„É©„Éº: ' + data.error; }
            } catch (err) { console.error(err); }
        });

        // „Çø„Ç§„Éû„Éº
        let startTime, timerInterval = null;
        startButton.addEventListener('click', () => {
            if (timerInterval) return;
            startTime = Date.now();
            timerInterval = setInterval(() => {
                timerElement.textContent = formatTime(Date.now() - startTime);
            }, 1000);
            resultElement.textContent = '';
        });

        stopButton.addEventListener('click', async () => {
            if (!timerInterval) return;
            clearInterval(timerInterval);
            timerInterval = null;
            const formattedTime = formatTime(Date.now() - startTime);
            
            const user = auth.currentUser;
            if (!user) return alert('„É≠„Ç∞„Ç§„É≥„Åó„Å¶„Åè„Å†„Åï„ÅÑ');

            try {
                await fetch('/log_training', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        'duration': formattedTime,
                        'user_name': user.displayName || user.email,
                        'memo': trainingMemoInput.value
                    })
                });
                loadActivities();
                trainingMemoInput.value = '';
            } catch (err) { console.error(err); }
            resultElement.textContent = `„ÅäÁñ≤„ÇåÊßòÔºÅ ÊôÇÈñì: ${formattedTime}`;
        });

        function formatTime(ms) {
            const s = Math.floor(ms / 1000) % 60;
            const m = Math.floor(ms / 1000 / 60) % 60;
            const h = Math.floor(ms / 1000 / 3600);
            return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
        }
    </script>
</body>
</html>